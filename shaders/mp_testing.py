import queue
from multiprocessing import Process, Queue
import psutil, os, time, math, pickle, random



def bloom_calculation(particle_map, nb, partition_size, send: Queue, recv: Queue):
    # print('module name:', __name__)
    # print('parent process:', os.getppid())
    # print('process id:', os.getpid())

    neighborhood = []
    for y in range(nb):
        for x in range(nb):
            neighborhood.append((x - nb//2, y - nb//2))
    while True:
        try:
            while recv_data := recv.get(True, 0.25):
                if not recv_data:
                    print("Nothing to render!")
                    continue

                if len(recv_data) > 2:
                    particle_map = recv_data
                    time.sleep(.001)
                    continue

                partition_x, partition_y = recv_data

                # print(f"{area_x + partition_x}x{area_y + partition_y}")
                nearby_particles = []
                nearby_particles += particle_map[partition_x][partition_y]
                # Grabbing neighboring partitions
                for x, y in neighborhood:
                    if 0 <= partition_x + x < len(particle_map) and 0 <= partition_y + y < len(particle_map[0]):
                        nearby_particles += particle_map[partition_x + x][partition_y + y]

                if not nearby_particles:
                    send.put(f"finished_partition {partition_x}x{partition_y}x{recv.qsize()}")
                    continue

                # Looping over each particle within the partition
                for x in range(partition_size):
                    for y in range(partition_size):
                        pos = (partition_x * partition_size + x, partition_y * partition_size + y)

                        # Finding minimum distance from a particle
                        min_dist, closest_part = 10000, None
                        for part_pos, color in nearby_particles:
                            dist = math.sqrt((pos[0] - part_pos[0]) ** 2 + (pos[1] - part_pos[1]) ** 2)
                            # dist = abs(pos[0] - part_pos[0]) + abs(pos[1] - part_pos[1])
                            if dist < min_dist:
                                min_dist = dist
                                closest_part = color

                        intensity = 1
                        if min_dist != 0:
                            intensity = 100 / (min_dist ** 2)

                        color = [closest_part[_] for _ in range(3)] + [min(255, 255 // 8 * intensity)]
                        send.put([int(pos[0]), int(pos[1]), *color])
                send.put(f"finished_partition {partition_x}x{partition_y}x{recv.qsize()}")
                # print(f"{int(pos.x)}x{int(pos.y)} = {color}")
                # win.set_at((int(pos.x), int(pos.y)), (255, 0, 0))
        except queue.Empty:
            send.put("need_data")
    # print("Done!")


if __name__ == '__main__':
    import pygame
    particle_map = [
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [[[17.39, 594.19], [71.15, 196.99, 168.47, 255.0]]], [], [], [], [], [],
         [[[13.35, 700.19], [66.18, 199.19, 174.49, 255.0]]]],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[35.91, 567.78], [52.91, 205.08, 190.57, 255.0]]], [], [],
         [[[33.73, 632.29], [67.83, 198.46, 172.48, 255.0]]], [], [[[29.62, 673.36], [79.44, 193.31, 158.42, 255.0]]],
         [[[25.99, 695.86], [74.47, 195.52, 164.45, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[49.61, 513.86], [51.25, 205.81, 192.58, 255.0]]], [], [], [],
         [[[48.27, 591.68], [71.15, 196.99, 168.47, 255.0]]], [], [], [], [],
         [[[47.9, 685.46], [82.76, 191.84, 154.4, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[65.64, 497.32], [72.81, 196.25, 166.46, 255.0]]], [], [], [], [], [], [],
         [[[64.42, 626.6], [52.91, 205.08, 190.57, 255.0]]], [], [],
         [[[77.31, 686.69], [57.88, 202.87, 184.54, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[86.05, 564.05], [57.88, 202.87, 184.54, 255.0]]], [], [], [],
         [[[93.55, 652.84], [61.2, 201.4, 180.52, 255.0]], [[89.97, 640.79], [77.78, 194.05, 160.43, 255.0]]],
         [[[81.22, 679.95], [56.22, 203.61, 186.55, 254.99]]], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[101.08, 489.57], [56.22, 203.61, 186.55, 254.99]]], [], [],
         [[[111.03, 546.29], [71.15, 196.99, 168.47, 255.0]]], [], [],
         [[[104.26, 618.69], [69.49, 197.72, 170.47, 255.0]]], [],
         [[[112.74, 647.52], [84.42, 191.11, 152.39, 255.0]], [[108.69, 642.75], [66.18, 199.19, 174.49, 255.0]]],
         [[[105.01, 667.78], [66.18, 199.19, 174.49, 255.0]], [[112.16, 676.02], [77.78, 194.05, 160.43, 255.0]],
          [[119.85, 670.71], [54.57, 204.34, 188.56, 255.0]]], [[[105.4, 688.05], [51.25, 205.81, 192.58, 255.0]]],
         [[[110.69, 709.58], [84.42, 191.11, 152.39, 255.0]], [[106.64, 707.79], [66.18, 199.19, 174.49, 255.0]]]],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[131.97, 492.39], [81.1, 192.58, 156.41, 255.0]]], [], [], [], [],
         [[[120.62, 596.88], [66.18, 199.19, 174.49, 255.0]]], [], [],
         [[[126.66, 652.57], [76.13, 194.78, 162.44, 255.0]]],
         [[[137.33, 662.81], [67.83, 198.46, 172.48, 255.0]], [[135.1, 667.29], [59.54, 202.14, 182.53, 255.0]]],
         [[[133.49, 697.83], [69.49, 197.72, 170.47, 255.0]], [[124.97, 682.52], [56.22, 203.61, 186.55, 254.99]]],
         [[[131.38, 711.1], [66.18, 199.19, 174.49, 255.0]], [[125.27, 712.32], [81.1, 192.58, 156.41, 255.0]]]],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [[[158.1, 627.39], [56.22, 203.61, 186.55, 254.99]]],
         [[[148.74, 646.63], [61.2, 201.4, 180.52, 255.0]], [[142.64, 657.35], [61.2, 201.4, 180.52, 255.0]],
          [[141.82, 656.92], [67.83, 198.46, 172.48, 255.0]]], [], [[[153.69, 683.59], [57.88, 202.87, 184.54, 255.0]]],
         []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [[[174.26, 596.49], [61.2, 201.4, 180.52, 255.0]]], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[189.07, 535.38], [62.86, 200.66, 178.51, 254.99]]], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[200.86, 566.65], [61.2, 201.4, 180.52, 255.0]]], [], [], [], [], [],
         [[[216.6, 690.8], [54.57, 204.34, 188.56, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[225.45, 545.19], [71.15, 196.99, 168.47, 255.0]]], [], [],
         [[[220.81, 612.58], [54.57, 204.34, 188.56, 255.0]], [[239.86, 606.62], [74.47, 195.52, 164.45, 255.0]]],
         [[[237.21, 639.44], [52.91, 205.08, 190.57, 255.0]]], [[[223.52, 647.47], [56.22, 203.61, 186.55, 254.99]]],
         [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[244.05, 353.86], [151.01, 169.4, 187.36, 255.0]]], [[[247.9, 373.61], [152.2, 165.79, 196.31, 255.0]]], [],
         [[[253.66, 406.2], [149.82, 173.01, 178.42, 255.0]]], [[[255.28, 433.89], [149.22, 174.81, 173.94, 255.0]]],
         [], [], [], [], [], [], [], [], [], [], [], [], [[[241.64, 688.45], [64.52, 199.93, 176.5, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[277.32, 331.19], [233.16, 124.99, 118.8, 255.0]]],
         [[[278.54, 359.92], [152.2, 165.79, 196.31, 255.0]], [[275.56, 351.66], [151.01, 169.4, 187.36, 255.0]],
          [[278.67, 355.37], [148.63, 176.62, 169.47, 255.0]], [[278.4, 346.26], [152.8, 163.99, 200.78, 255.0]]],
         [[[262.14, 379.16], [149.82, 173.01, 178.42, 255.0]]], [[[268.95, 386.05], [151.01, 169.4, 187.36, 255.0]]],
         [[[271.99, 405.97], [149.82, 173.01, 178.42, 255.0]], [[260.05, 406.22], [149.22, 174.81, 173.94, 255.0]]], [],
         [[[278.58, 444.11], [151.01, 169.4, 187.36, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [[[293.15, 160.59], [255.0, 255.0, 255.0]]], [], [], [], [], [], [], [],
         [[[289.43, 339.02], [228.36, 117.31, 130.03, 255.0]], [[283.76, 335.78], [230.76, 121.15, 124.41, 255.0]]],
         [[[285.31, 359.46], [151.61, 167.6, 191.83, 255.0]], [[299.34, 359.76], [152.8, 163.99, 200.78, 255.0]],
          [[289.74, 353.82], [149.82, 173.01, 178.42, 255.0]]],
         [[[283.68, 369.96], [234.53, 125.68, 124.03, 255.0]], [[286.67, 379.91], [149.22, 174.81, 173.94, 255.0]],
          [[296.45, 379.75], [148.63, 176.62, 169.47, 255.0]], [[297.91, 366.98], [149.22, 174.81, 173.94, 255.0]],
          [[298.05, 374.32], [150.41, 171.21, 182.89, 255.0]]],
         [[[297.96, 381.13], [152.2, 165.79, 196.31, 255.0]], [[296.7, 384.77], [149.22, 174.81, 173.94, 255.0]],
          [[289.42, 382.38], [152.2, 165.79, 196.31, 255.0]], [[291.53, 388.28], [150.41, 171.21, 182.89, 255.0]],
          [[294.69, 383.02], [152.8, 163.99, 200.78, 255.0]]],
         [[[295.51, 401.29], [149.22, 174.81, 173.94, 255.0]], [[292.87, 416.94], [149.82, 173.01, 178.42, 255.0]]],
         [[[299.25, 431.49], [150.41, 171.21, 182.89, 255.0]]], [[[299.28, 448.03], [229.56, 119.23, 127.22, 255.0]]],
         [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[303.49, 319.58], [151.61, 167.6, 191.83, 255.0]]],
         [[[319.84, 334.53], [231.96, 123.07, 121.6, 255.0]], [[302.21, 334.82], [149.22, 174.81, 173.94, 255.0]],
          [[305.81, 327.69], [151.61, 167.6, 191.83, 255.0]], [[311.9, 336.78], [151.01, 169.4, 187.36, 255.0]]],
         [[[307.62, 343.55], [148.63, 176.62, 169.47, 255.0]], [[308.14, 343.24], [151.01, 169.4, 187.36, 255.0]],
          [[307.55, 350.13], [149.82, 173.01, 178.42, 255.0]], [[306.61, 348.43], [151.01, 169.4, 187.36, 255.0]]],
         [[[318.77, 367.22], [233.16, 124.99, 118.8, 255.0]], [[309.41, 378.09], [151.01, 169.4, 187.36, 255.0]]],
         [[[318.69, 382.59], [231.96, 123.07, 121.6, 255.0]], [[301.79, 380.53], [150.41, 171.21, 182.89, 255.0]],
          [[302.82, 385.61], [149.82, 173.01, 178.42, 255.0]], [[306.06, 385.37], [151.61, 167.6, 191.83, 255.0]],
          [[302.85, 381.06], [151.61, 167.6, 191.83, 255.0]], [[301.27, 385.14], [151.01, 169.4, 187.36, 255.0]],
          [[311.55, 388.7], [151.61, 167.6, 191.83, 255.0]], [[315.06, 380.63], [152.2, 165.79, 196.31, 255.0]],
          [[310.27, 394.27], [149.22, 174.81, 173.94, 255.0]], [[300.49, 385.89], [152.2, 165.79, 196.31, 255.0]],
          [[300.54, 392.66], [151.01, 169.4, 187.36, 255.0]], [[300.89, 384.33], [152.8, 163.99, 200.78, 255.0]],
          [[303.55, 380.47], [151.01, 169.4, 187.36, 255.0]], [[315.13, 382.81], [148.63, 176.62, 169.47, 255.0]],
          [[303.64, 383.15], [151.01, 169.4, 187.36, 255.0]]], [[[300.87, 403.0], [149.22, 174.81, 173.94, 255.0]]],
         [[[310.14, 437.71], [150.41, 171.21, 182.89, 255.0]], [[305.43, 437.56], [149.82, 173.01, 178.42, 255.0]]],
         [[[315.5, 442.18], [228.36, 117.31, 130.03, 255.0]], [[312.26, 443.07], [151.01, 169.4, 187.36, 255.0]]], [],
         [], [], [], [], [], [], [], [], [[[303.89, 647.02], [61.2, 201.4, 180.52, 255.0]]], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [[[337.42, 287.25], [234.44, 126.3, 120.01, 255.0]]],
         [], [[[329.59, 337.54], [234.53, 125.68, 124.03, 255.0]], [[339.13, 336.22], [230.76, 121.15, 124.41, 255.0]],
              [[330.18, 332.85], [149.82, 173.01, 178.42, 255.0]]],
         [[[330.69, 352.73], [230.76, 121.15, 124.41, 255.0]], [[331.38, 346.95], [233.16, 124.99, 118.8, 255.0]],
          [[328.08, 350.47], [152.8, 163.99, 200.78, 255.0]], [[321.07, 355.28], [149.22, 174.81, 173.94, 255.0]],
          [[329.69, 346.56], [149.22, 174.81, 173.94, 255.0]]], [[[332.26, 375.6], [150.41, 171.21, 182.89, 255.0]]],
         [[[336.78, 390.31], [234.4, 126.6, 118.0, 255.0]], [[326.6, 390.89], [230.76, 121.15, 124.41, 255.0]],
          [[328.18, 382.37], [149.82, 173.01, 178.42, 255.0]], [[329.85, 386.53], [150.41, 171.21, 182.89, 255.0]],
          [[320.87, 393.36], [149.82, 173.01, 178.42, 255.0]]],
         [[[320.93, 401.66], [230.76, 121.15, 124.41, 255.0]], [[326.06, 406.51], [148.63, 176.62, 169.47, 255.0]],
          [[335.25, 408.12], [150.41, 171.21, 182.89, 255.0]], [[320.21, 401.08], [152.2, 165.79, 196.31, 255.0]]],
         [[[322.07, 420.25], [149.22, 174.81, 173.94, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[356.46, 355.06], [230.76, 121.15, 124.41, 255.0]], [[340.56, 356.31], [234.53, 125.68, 124.03, 255.0]]],
         [[[358.69, 371.88], [230.76, 121.15, 124.41, 255.0]], [[358.85, 373.11], [234.57, 125.38, 126.04, 255.0]],
          [[352.83, 363.42], [231.96, 123.07, 121.6, 255.0]], [[357.01, 375.35], [231.96, 123.07, 121.6, 255.0]]],
         [[[359.71, 388.88], [228.36, 117.31, 130.03, 255.0]], [[359.88, 389.8], [149.82, 173.01, 178.42, 255.0]],
          [[340.13, 398.33], [150.41, 171.21, 182.89, 255.0]], [[341.9, 392.27], [151.01, 169.4, 187.36, 255.0]]],
         [[[354.74, 413.68], [152.2, 165.79, 196.31, 255.0]], [[341.08, 411.66], [149.22, 174.81, 173.94, 255.0]]], [],
         [[[346.83, 457.44], [234.4, 126.6, 118.0, 255.0]]], [[[343.2, 464.3], [231.96, 123.07, 121.6, 255.0]]], [], [],
         [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[367.93, 358.37], [234.4, 126.6, 118.0, 255.0]]],
         [[[372.18, 369.05], [229.56, 119.23, 127.22, 255.0]], [[368.59, 363.31], [234.49, 125.99, 122.02, 255.0]],
          [[379.7, 368.73], [233.16, 124.99, 118.8, 255.0]]],
         [[[369.46, 386.37], [229.56, 119.23, 127.22, 255.0]], [[365.32, 392.1], [234.36, 126.91, 115.99, 255.0]]], [],
         [[[364.1, 423.7], [230.76, 121.15, 124.41, 255.0]], [[366.57, 421.91], [230.76, 121.15, 124.41, 255.0]]], [],
         [[[369.28, 476.14], [234.62, 125.07, 128.05, 255.0]], [[369.21, 461.24], [234.62, 125.07, 128.05, 255.0]]], [],
         [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[393.44, 300.71], [229.56, 119.23, 127.22, 255.0]]], [[[385.33, 334.68], [234.36, 126.91, 115.99, 255.0]]],
         [[[384.92, 353.17], [231.96, 123.07, 121.6, 255.0]], [[390.71, 343.82], [231.96, 123.07, 121.6, 255.0]]],
         [[[380.74, 379.42], [231.96, 123.07, 121.6, 255.0]]], [],
         [[[380.31, 407.97], [234.36, 126.91, 115.99, 255.0]]],
         [[[390.16, 439.42], [255.0, 255.0, 255.0]], [[393.14, 434.26], [234.4, 126.6, 118.0, 255.0]],
          [[388.76, 437.62], [234.57, 125.38, 126.04, 255.0]]], [[[384.67, 440.1], [234.44, 126.3, 120.01, 255.0]]], [],
         [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[409.44, 314.05], [228.36, 117.31, 130.03, 255.0]], [[408.66, 300.8], [230.76, 121.15, 124.41, 255.0]]], [],
         [], [[[403.16, 378.44], [228.36, 117.31, 130.03, 255.0]]], [],
         [[[411.15, 416.61], [234.57, 125.38, 126.04, 255.0]]],
         [[[417.47, 429.56], [231.96, 123.07, 121.6, 255.0]], [[409.02, 427.48], [234.62, 125.07, 128.05, 255.0]]],
         [[[404.07, 443.64], [229.56, 119.23, 127.22, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[423.67, 362.13], [234.57, 125.38, 126.04, 255.0]]], [[[438.91, 381.15], [233.16, 124.99, 118.8, 255.0]]],
         [[[433.19, 404.25], [234.36, 126.91, 115.99, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[442.26, 370.89], [234.36, 126.91, 115.99, 255.0]], [[455.94, 377.11], [229.56, 119.23, 127.22, 255.0]]], [],
         [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[546.7, 487.24], [20.83, 178.66, 194.43, 255.0]]],
         [[[543.61, 515.76], [20.72, 181.72, 193.59, 255.0]], [[559.34, 515.66], [15.11, 180.54, 194.68, 255.0]]], [],
         [], [], [[[540.95, 583.47], [20.83, 178.66, 194.43, 255.0]]], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[574.69, 425.88], [28.44, 176.17, 194.09, 255.0]]], [], [], [], [],
         [[[571.81, 532.52], [24.63, 177.42, 194.26, 255.0]], [[579.72, 531.5], [17.02, 179.91, 194.59, 255.0]]], [],
         [[[563.08, 577.22], [26.33, 182.91, 192.5, 255.0]]], [], [[[567.66, 606.79], [141.1, 130.84, 231.12, 254.99]]],
         [], [[[572.72, 654.05], [142.97, 117.91, 232.09, 255.0]]], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[593.52, 413.68], [18.92, 179.29, 194.51, 255.0]]], [], [],
         [[[590.39, 477.88], [32.25, 174.92, 193.92, 255.0]]],
         [[[585.63, 491.75], [141.31, 129.4, 231.23, 255.0]], [[596.19, 484.66], [26.54, 176.79, 194.17, 255.0]],
          [[589.65, 482.05], [15.11, 180.54, 194.68, 255.0]]], [], [], [],
         [[[583.12, 573.34], [17.02, 179.91, 194.59, 255.0]]], [[[598.54, 583.48], [142.14, 123.65, 231.66, 255.0]]],
         [[[583.62, 615.34], [17.02, 179.91, 194.59, 255.0]]], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[612.97, 449.64], [30.35, 175.55, 194.0, 255.0]]],
         [[[605.87, 465.66], [22.73, 178.04, 194.34, 255.0]], [[603.93, 467.19], [22.73, 178.04, 194.34, 255.0]]],
         [[[609.97, 489.75], [20.83, 178.66, 194.43, 255.0]], [[602.44, 496.78], [28.44, 176.17, 194.09, 255.0]]],
         [[[606.72, 500.68], [142.76, 119.34, 231.98, 255.0]], [[605.68, 518.27], [140.89, 132.28, 231.01, 255.0]],
          [[609.82, 517.68], [22.73, 178.04, 194.34, 255.0]], [[600.51, 514.03], [17.02, 179.91, 194.59, 255.0]],
          [[619.69, 517.63], [32.25, 174.92, 193.92, 255.0]]],
         [[[617.14, 536.4], [31.94, 184.09, 191.41, 255.0]], [[612.88, 525.2], [20.83, 178.66, 194.43, 255.0]]],
         [[[607.0, 546.59], [26.33, 182.91, 192.5, 255.0]]],
         [[[615.81, 579.79], [140.68, 133.71, 230.91, 255.0]], [[618.16, 569.07], [26.54, 176.79, 194.17, 255.0]]],
         [[[617.46, 599.52], [20.72, 181.72, 193.59, 255.0]]],
         [[[600.32, 602.36], [143.39, 115.03, 232.31, 254.99]], [[612.59, 603.07], [140.68, 133.71, 230.91, 255.0]]],
         [[[613.02, 632.52], [142.14, 123.65, 231.66, 255.0]], [[619.95, 628.33], [17.02, 179.91, 194.59, 255.0]],
          [[612.8, 634.64], [26.54, 176.79, 194.17, 255.0]]], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[635.12, 458.87], [140.89, 132.28, 231.01, 255.0]]], [[[630.07, 467.62], [15.11, 180.54, 194.68, 255.0]]],
         [], [[[638.58, 516.36], [34.15, 174.3, 193.83, 255.0]]],
         [[[628.53, 522.83], [26.54, 176.79, 194.17, 255.0]], [[620.71, 522.14], [26.33, 182.91, 192.5, 255.0]],
          [[629.78, 522.5], [26.33, 182.91, 192.5, 255.0]], [[631.06, 520.44], [26.54, 176.79, 194.17, 255.0]]],
         [[[629.97, 549.38], [142.14, 123.65, 231.66, 255.0]], [[639.82, 545.94], [18.92, 179.29, 194.51, 255.0]],
          [[623.82, 540.19], [24.63, 177.42, 194.26, 255.0]], [[621.39, 555.81], [18.92, 179.29, 194.51, 255.0]]],
         [[[635.95, 570.96], [26.54, 176.79, 194.17, 255.0]]], [], [], [], [], [],
         [[[629.09, 690.18], [141.52, 127.97, 231.34, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[654.66, 427.57], [20.72, 181.72, 193.59, 255.0]]], [[[649.33, 458.86], [26.54, 176.79, 194.17, 255.0]]],
         [[[644.44, 474.32], [20.72, 181.72, 193.59, 255.0]]],
         [[[647.99, 496.19], [30.35, 175.55, 194.0, 255.0]], [[649.33, 483.76], [31.94, 184.09, 191.41, 255.0]],
          [[659.44, 491.46], [17.02, 179.91, 194.59, 255.0]]], [],
         [[[645.52, 528.41], [17.02, 179.91, 194.59, 255.0]], [[648.0, 533.01], [18.92, 179.29, 194.51, 255.0]],
          [[644.08, 535.97], [28.44, 176.17, 194.09, 255.0]]], [[[652.36, 559.7], [31.94, 184.09, 191.41, 255.0]]], [],
         [], [[[653.26, 616.68], [26.33, 182.91, 192.5, 255.0]]], [[[656.6, 635.71], [26.33, 182.91, 192.5, 255.0]]],
         [], [], [], [[[641.71, 702.57], [143.39, 115.03, 232.31, 254.99]]]],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[674.18, 450.71], [140.89, 132.28, 231.01, 255.0]]], [], [[[666.22, 494.45], [30.35, 175.55, 194.0, 255.0]]],
         [[[670.86, 507.8], [24.63, 177.42, 194.26, 255.0]], [[674.27, 515.95], [20.83, 178.66, 194.43, 255.0]],
          [[666.58, 517.05], [24.63, 177.42, 194.26, 255.0]]],
         [[[669.34, 528.46], [143.59, 113.6, 232.41, 255.0]], [[661.88, 535.12], [18.92, 179.29, 194.51, 255.0]],
          [[665.08, 532.13], [20.83, 178.66, 194.43, 255.0]]], [],
         [[[676.49, 560.64], [141.31, 129.4, 231.23, 255.0]], [[665.28, 572.83], [143.59, 113.6, 232.41, 255.0]],
          [[676.69, 576.67], [142.35, 122.22, 231.77, 255.0]], [[663.46, 573.49], [22.73, 178.04, 194.34, 255.0]]],
         [[[673.62, 591.52], [142.14, 123.65, 231.66, 255.0]]],
         [[[668.63, 602.65], [141.52, 127.97, 231.34, 255.0]], [[665.18, 612.05], [141.93, 125.09, 231.55, 255.0]]],
         [[[675.38, 638.7], [140.89, 132.28, 231.01, 255.0]]], [[[664.14, 656.1], [141.52, 127.97, 231.34, 255.0]]],
         [[[672.37, 677.6], [141.72, 126.53, 231.44, 255.0]]], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[683.76, 437.88], [18.92, 179.29, 194.51, 255.0]]], [], [[[683.37, 463.68], [26.33, 182.91, 192.5, 255.0]]],
         [[[690.66, 490.81], [17.02, 179.91, 194.59, 255.0]]], [[[695.35, 516.33], [31.94, 184.09, 191.41, 255.0]]], [],
         [], [[[699.04, 569.53], [141.31, 129.4, 231.23, 255.0]], [[696.18, 570.29], [141.72, 126.53, 231.44, 255.0]],
              [[697.47, 570.87], [140.89, 132.28, 231.01, 255.0]]],
         [[[699.5, 584.78], [141.1, 130.84, 231.12, 254.99]], [[683.94, 597.16], [141.72, 126.53, 231.44, 255.0]],
          [[686.14, 582.38], [140.27, 136.59, 230.69, 255.0]]], [[[687.71, 613.68], [142.55, 120.78, 231.88, 255.0]]],
         [], [], [[[689.81, 670.84], [140.27, 136.59, 230.69, 255.0]]], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[704.94, 453.01], [143.18, 116.47, 232.2, 255.0]]], [[[712.11, 464.13], [140.68, 133.71, 230.91, 255.0]]],
         [], [[[707.87, 507.05], [141.1, 130.84, 231.12, 254.99]], [[711.55, 505.61], [30.35, 175.55, 194.0, 255.0]],
              [[711.09, 515.28], [22.73, 178.04, 194.34, 255.0]]], [[[706.52, 525.08], [31.94, 184.09, 191.41, 255.0]]],
         [[[707.2, 556.41], [20.72, 181.72, 193.59, 255.0]]],
         [[[701.16, 567.8], [141.93, 125.09, 231.55, 255.0]], [[709.24, 572.11], [140.27, 136.59, 230.69, 255.0]],
          [[702.89, 568.86], [141.52, 127.97, 231.34, 255.0]]], [[[711.75, 595.5], [141.1, 130.84, 231.12, 254.99]]],
         [], [], [],
         [[[715.56, 668.65], [143.18, 116.47, 232.2, 255.0]], [[718.57, 677.04], [140.89, 132.28, 231.01, 255.0]]], [],
         []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[730.42, 488.88], [142.97, 117.91, 232.09, 255.0]], [[737.25, 487.86], [18.92, 179.29, 194.51, 255.0]]],
         [[[730.61, 513.58], [20.72, 181.72, 193.59, 255.0]]], [], [],
         [[[720.47, 573.34], [142.76, 119.34, 231.98, 255.0]]],
         [[[736.0, 590.41], [140.89, 132.28, 231.01, 255.0]], [[727.7, 595.79], [140.48, 135.15, 230.8, 255.0]],
          [[727.02, 580.31], [143.59, 113.6, 232.41, 255.0]]], [[[736.81, 616.58], [141.31, 129.4, 231.23, 255.0]]],
         [[[727.33, 625.25], [141.72, 126.53, 231.44, 255.0]]], [], [],
         [[[738.96, 691.27], [141.93, 125.09, 231.55, 255.0]], [[727.62, 688.72], [140.27, 136.59, 230.69, 255.0]]],
         []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[749.14, 461.45], [141.93, 125.09, 231.55, 255.0]]], [], [], [],
         [[[741.07, 540.56], [141.72, 126.53, 231.44, 255.0]]], [],
         [[[756.92, 599.93], [140.27, 136.59, 230.69, 255.0]]], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[761.56, 509.08], [141.72, 126.53, 231.44, 255.0]]], [], [], [], [], [],
         [[[763.5, 638.48], [140.27, 136.59, 230.69, 255.0]]], [], [],
         [[[764.59, 688.81], [141.93, 125.09, 231.55, 255.0]]], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[794.53, 536.43], [141.31, 129.4, 231.23, 255.0]]], [], [], [], [], [],
         [[[789.94, 651.1], [141.93, 125.09, 231.55, 255.0]]], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[819.37, 362.86], [255.0, 255.0, 255.0]]], [], [], [], [], [], [], [], [],
         [[[810.94, 557.14], [141.93, 125.09, 231.55, 255.0]]], [], [], [], [],
         [[[814.69, 654.58], [141.52, 127.97, 231.34, 255.0]]], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[852.55, 459.62], [255.0, 255.0, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[898.13, 364.01], [75.29, 230.33, 141.2, 255.0]], [[897.13, 372.36], [72.74, 231.62, 138.63, 255.0]],
          [[893.55, 371.54], [72.74, 231.62, 138.63, 255.0]], [[893.25, 370.79], [72.74, 231.62, 138.63, 255.0]],
          [[899.34, 379.59], [72.74, 231.62, 138.63, 255.0]]],
         [[[899.18, 383.24], [72.74, 231.62, 138.63, 255.0]], [[899.1, 398.7], [70.19, 232.91, 136.07, 255.0]],
          [[896.59, 391.57], [70.19, 232.91, 136.07, 255.0]], [[891.97, 395.19], [72.74, 231.62, 138.63, 255.0]],
          [[898.97, 393.36], [70.19, 232.91, 136.07, 255.0]], [[889.18, 386.21], [72.74, 231.62, 138.63, 255.0]]], [],
         [], [], [], [], [], [], [], [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[901.71, 371.4], [72.74, 231.62, 138.63, 255.0]], [[906.85, 362.36], [75.29, 230.33, 141.2, 255.0]],
          [[907.95, 372.52], [72.74, 231.62, 138.63, 255.0]], [[912.18, 375.54], [72.74, 231.62, 138.63, 255.0]],
          [[910.37, 379.87], [72.74, 231.62, 138.63, 255.0]], [[900.6, 376.74], [72.74, 231.62, 138.63, 255.0]],
          [[913.76, 373.26], [70.19, 232.91, 136.07, 255.0]], [[919.53, 367.75], [70.19, 232.91, 136.07, 255.0]],
          [[902.09, 379.69], [70.19, 232.91, 136.07, 255.0]], [[912.09, 376.85], [75.29, 230.33, 141.2, 255.0]],
          [[905.53, 378.48], [75.29, 230.33, 141.2, 255.0]], [[904.29, 375.85], [72.74, 231.62, 138.63, 255.0]],
          [[911.18, 378.45], [75.29, 230.33, 141.2, 255.0]], [[919.89, 369.27], [70.19, 232.91, 136.07, 255.0]],
          [[912.92, 375.71], [72.74, 231.62, 138.63, 255.0]], [[904.41, 370.66], [70.19, 232.91, 136.07, 255.0]],
          [[908.51, 378.76], [72.74, 231.62, 138.63, 255.0]]],
         [[[909.42, 383.78], [72.74, 231.62, 138.63, 255.0]], [[919.64, 388.17], [72.74, 231.62, 138.63, 255.0]],
          [[909.41, 383.19], [72.74, 231.62, 138.63, 255.0]], [[912.78, 399.53], [75.29, 230.33, 141.2, 255.0]],
          [[916.94, 397.52], [70.19, 232.91, 136.07, 255.0]], [[908.52, 382.61], [72.74, 231.62, 138.63, 255.0]],
          [[906.37, 398.4], [75.29, 230.33, 141.2, 255.0]], [[906.56, 387.28], [72.74, 231.62, 138.63, 255.0]],
          [[910.46, 390.07], [70.19, 232.91, 136.07, 255.0]], [[909.42, 384.23], [70.19, 232.91, 136.07, 255.0]],
          [[909.18, 382.34], [72.74, 231.62, 138.63, 255.0]], [[912.96, 381.27], [72.74, 231.62, 138.63, 255.0]],
          [[907.18, 385.55], [72.74, 231.62, 138.63, 255.0]], [[900.15, 392.37], [70.19, 232.91, 136.07, 255.0]],
          [[905.16, 387.94], [70.19, 232.91, 136.07, 255.0]], [[909.21, 382.42], [70.19, 232.91, 136.07, 255.0]],
          [[911.48, 386.29], [70.19, 232.91, 136.07, 255.0]], [[919.09, 382.43], [72.74, 231.62, 138.63, 255.0]],
          [[909.42, 387.11], [72.74, 231.62, 138.63, 255.0]], [[905.38, 397.13], [72.74, 231.62, 138.63, 255.0]],
          [[904.74, 392.88], [72.74, 231.62, 138.63, 255.0]], [[905.91, 391.19], [72.74, 231.62, 138.63, 255.0]],
          [[915.08, 380.96], [70.19, 232.91, 136.07, 255.0]], [[906.29, 383.15], [75.29, 230.33, 141.2, 255.0]],
          [[908.4, 382.36], [70.19, 232.91, 136.07, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[928.69, 378.07], [75.29, 230.33, 141.2, 255.0]], [[924.69, 376.73], [72.74, 231.62, 138.63, 255.0]],
          [[923.04, 374.58], [75.29, 230.33, 141.2, 255.0]]],
         [[[920.9, 390.54], [72.74, 231.62, 138.63, 255.0]], [[926.1, 385.51], [72.74, 231.62, 138.63, 255.0]],
          [[929.15, 386.21], [70.19, 232.91, 136.07, 255.0]], [[924.42, 398.1], [70.19, 232.91, 136.07, 255.0]],
          [[924.86, 392.35], [75.29, 230.33, 141.2, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [[[1227.28, 371.34], [255.0, 255.0, 255.0]]], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []],
        [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [],
         [], [], [], [], [], [], [], []]
    ]

    width, height = 1280, 720
    partition_size = 20
    nb_size = 9

    partitions_wide, partitions_tall = width // partition_size, height // partition_size
    print(f"{partitions_wide}x{partitions_tall}")

    pygame.init()
    display, clock = pygame.display.Info(), pygame.time.Clock()
    width, height = display.current_w // 2, display.current_h // 2
    win = pygame.display.set_mode((width, height), pygame.HWACCEL)

    thread_count = psutil.cpu_count(logical=True) - 2

    send, recv = Queue(), Queue()

    pipes, processes = [], []
    for i in range(0, partitions_wide, partitions_wide // thread_count):
        process = Process(target=bloom_calculation, args=(particle_map, nb_size, partition_size, recv, send))

        # pipes.append(parent_connection)
        processes.append(process)
        process.start()

    def render(current_particle_map):
        send.empty()
        surf = pygame.Surface((width, height), pygame.SRCALPHA | pygame.HWSURFACE)
        win.fill((0, 0, 0))
        win.blit(surf, (0, 0))
        pygame.display.update()

        for i in range(thread_count):
            send.put(current_particle_map)

        todo = []
        for partition_y in range(partitions_tall):
            for partition_x in range(partitions_wide):
                partition = [partition_x, partition_y]
                send.put(partition)
                todo.append(partition)
        print(f"done filling {len(todo)}")

        print("Ready")
        start_time = time.time()

        to_draw = []

        last_size = 0
        while (data := recv.get()) and todo:
            # print("received data")
            events = pygame.event.get()
            for event in events:
                pass
            if isinstance(data, str):
                if data.startswith("finished_partition"):
                    x, y, left = [int(i) for i in data[data.rfind(" "):].split("x")]
                    # print(f"{x, y}", left, len(todo))
                    if [x, y] in todo:
                        todo.remove([x, y])

                    win.fill((0, 0, 0))
                    win.blit(surf, (0, 0))
                    pygame.display.update()

                if data == "need_data":
                    for partition in range(min(100, len(todo))):
                        send.put(todo[random.randint(0, len(todo) - 1)])
            else:
                surf.set_at(data[:2], data[2:])
                # to_draw.append(data)

        print(f"Total Time: {time.time() - start_time}s")

        # for data in to_draw:
        #     surf.set_at(data[:2], data[2:])

        win.fill((0, 0, 0))
        win.blit(surf, (0, 0))
        pygame.display.update()
        # win.blit(surf, (0, 0))
        # pygame.display.update()
        print("Finished")

    # render(particle_map)

    for num in range(35):
        file = open(f"../bins/particles_{num:06}.dat", "rb")
        cp = pickle.load(file)
        render(cp)

    running = True
    while running:
        # print("looping")
        events = pygame.event.get()
        for event in events:
            if event.type == pygame.QUIT:
                running = False
            running = False
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_ESCAPE:
                    running = False

    for process in processes:
        print("Joining!")
        process.join()
